<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>InsecMed - Medical Vision Q&A</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='sidebar.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/vs.min.css">
  <style>
    body { background:#f5f7fa; margin:0; transition:padding-left .3s ease; }
    .content { padding:20px; transition:margin-left .3s ease; }
    .sidebar-collapsed ~ .content { margin-left:60px; }
    .sidebar-expanded ~ .content { margin-left:200px; }
    #result{white-space:pre-wrap;background:#f8fafc;padding:15px;border-radius:10px;border:1px solid #d1d5db;font-family:monospace;font-size:14px;}
    #imagePreview{max-width:100%;max-height:300px;margin-top:15px;border-radius:10px;border:1px solid #0052cc;}
    .answer-text{font-size:1.3rem;font-weight:bold;color:#0052cc;}
  </style>
</head>
<body class="sidebar-collapsed">

  {% include 'sidebar.html' %}

  <div class="content">
    <div class="container py-5">
      <div class="text-center mb-4">
        <h1 class="fw-bold text-primary">Medical Vision Q&A</h1>
        <p class="text-muted">Tải ảnh và đặt câu hỏi để nhận câu trả lời</p>
      </div>
      <div class="card p-4">
        <form id="questionForm">
          {% if isDoctor %}
          <div class="mb-3">
            <label class="form-label fw-bold">Mã bệnh nhân:</label>
            <select class="form-select" name="patient_id" id="idSelect" required>
              <option value="">-- Chọn bệnh nhân --</option>
              {% for patient in patients %}
                <option value="{{ patient[0] }}">{{ patient[0] }} - {{ patient[1] }}</option>
              {% endfor %}
            </select>
          </div>
          {% else %}
            <input type="hidden" name="patient_id" value="BN_{{ patient_id }}">
          {% endif %}

          <div class="mb-3">
            <label class="form-label fw-bold">Chọn loại bệnh:</label>
            <select class="form-select" id="diseaseSelect" required>
              <option value="">-- Chọn loại bệnh --</option>
              <option value="general">Chẩn đoán tổng quát</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Chọn model:</label>
            <select class="form-select" name="model" id="modelSelect" required disabled>
              <option value="">-- Chọn model --</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Câu hỏi:</label>
            <textarea class="form-control" name="question" rows="4" placeholder="Nhập câu hỏi..." required></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Chọn ảnh (png, jpg, jpeg, nrrd, hdr, img, nii, gz, dcm) — tối đa 10MB:</label>
            <input type="file" class="form-control" name="file" accept=".png,.jpg,.jpeg,.dcm" required>
          </div>

          <button type="submit" id="submitBtn" class="btn btn-primary w-100">Gửi câu hỏi</button>
        </form>

        <div class="mt-4">
          <h5>Image Preview</h5>
          <img id="imagePreview" style="display:none;">
        </div>

        <div class="mt-4">
          <h5>Answer Output</h5>
          <pre><code id="result" class="language-json">Chưa có câu trả lời</code></pre>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="text-align:center; padding:2rem;">
          <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
          <p>Đang chẩn đoán, vui lòng đợi...</p>
        </div>
      </div>
    </div>

    <!-- Modal Loading khi upload -->
    <div class="modal fade" id="uploadLoadingModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">
          <div class="spinner-border text-primary mb-3" role="status"></div>
          <h5>Đang xử lý ảnh...</h5>
          <p class="text-muted mb-0">Vui lòng chờ trong giây lát</p>
        </div>
      </div>
    </div>

    <!-- Modal cảnh báo ảnh không phải y tế -->
    <div class="modal fade" id="nonMedicalConfirmModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title">Cảnh báo</h5>
          </div>
          <div class="modal-body">
            Ảnh tải lên <strong>KHÔNG PHẢI ảnh y tế</strong>.<br>
            Bạn có chắc muốn tiếp tục chẩn đoán với ảnh này?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancelProceedBtn">Hủy</button>
            <button type="button" class="btn btn-primary" id="confirmProceedBtn">Tiếp tục</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Answer Modal -->
    <div class="modal fade" id="answerAlert" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Câu trả lời</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="answer-text" id="modalAnswerText">Chưa có câu trả lời</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <script src="{{ url_for('static', filename='sidebar.js') }}"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      hljs.highlightAll();
    
      const diseaseSelect = document.getElementById("diseaseSelect");
      const modelSelect = document.getElementById("modelSelect");
      const fileInput = document.querySelector('input[name="file"]');
      const preview = document.getElementById("imagePreview");
      const submitBtn = document.getElementById("submitBtn");
      const form = document.getElementById("questionForm");
      const resultBox = document.getElementById("result");
      const uploadLoadingModal = new bootstrap.Modal(document.getElementById("uploadLoadingModal"));
      const nonMedicalModal = new bootstrap.Modal(document.getElementById("nonMedicalConfirmModal"));
      let userConfirmedProceed = false;
    
      // --- Chọn model ---
      const diseaseModels = {
        general: [{ value: "med-gemma-4b", text: "Độ chính xác cao - MedGemma 4b" }]
      };
      diseaseSelect.addEventListener("change", function() {
        const selectedDisease = this.value;
        modelSelect.innerHTML = '<option value="">-- Chọn model --</option>';
        modelSelect.disabled = !selectedDisease;
        if (selectedDisease && diseaseModels[selectedDisease]) {
          diseaseModels[selectedDisease].forEach(m => {
            const opt = document.createElement("option");
            opt.value = m.value;
            opt.text = m.text;
            modelSelect.appendChild(opt);
          });
        }
      });

      convertedImageFile = null;
    
      // --- Khi người dùng chọn ảnh ---
      fileInput.addEventListener("change", async e => {
        convertedImageFile = null;
        const file = e.target.files[0];
        if (!file) {
          preview.style.display = "none";
          submitBtn.disabled = true;
          return;
        }
    
        submitBtn.disabled = true; // Tạm khóa cho đến khi ảnh hợp lệ
        userConfirmedProceed = false;
        resultBox.textContent = "";
    
        try {
          let processedFile = file;
          // Danh sách extension hợp lệ
          const allowedExtensions = ['.dcm', '.jpg', '.jpeg', '.png', '.nii', '.gz', '.hdr', '.img', '.nrrd'];

          // Lấy tên file và chuyển về lowercase
          const filename = file.name.toLowerCase();

          // Kiểm tra xem filename có kết thúc bằng bất kỳ extension nào trong list
          if (!allowedExtensions.some(ext => filename.endsWith(ext))) {
              throw new Error(`File không hợp lệ: chỉ cho phép ${allowedExtensions.join(', ')}`);
          }

          uploadLoadingModal.show();

          // Nếu là file DICOM → convert trước
          const convertForm = new FormData();
          convertForm.append("image", file);
          const convertResp = await fetch("{{ img_host }}/convert", { method: "POST", body: convertForm });
          if (!convertResp.ok) throw new Error("Không thể convert ảnh");
          const blob = await convertResp.blob();
          processedFile = new File([blob], file.name + ".png", { type: "image/png" });
          preview.src = URL.createObjectURL(blob);
          
    
          preview.style.display = "block";
    
          // Infer để kiểm tra xem có phải ảnh y tế không
          const inferForm = new FormData();
          inferForm.append("image", processedFile);
          const inferResp = await fetch("{{ img_host }}/infer", { method: "POST", body: inferForm });
          uploadLoadingModal.hide();
          if (!inferResp.ok) throw new Error("Không thể kiểm tra loại ảnh");
  
          const inferData = await inferResp.json();
          if (inferData.prediction === "Positive") {
            submitBtn.disabled = false; // Ảnh y tế → cho phép gửi
          } else {
            // Không phải ảnh y tế → hỏi người dùng
            nonMedicalModal.show();

            document.getElementById("cancelProceedBtn").onclick = () => {
              nonMedicalModal.hide();
              fileInput.value = "";
              preview.src = "";
              preview.style.display = "none";
              submitBtn.disabled = true;
            };
      
            document.getElementById("confirmProceedBtn").onclick = () => {
              nonMedicalModal.hide();
              convertedImageFile = processedFile;
              submitBtn.disabled = false;
              form.requestSubmit();
            };

          }
        } catch (err) {
          alert("Lỗi xử lý ảnh: " + err.message);
          preview.style.display = "none";
          submitBtn.disabled = true;
        }
      });
    
      // --- Submit form như cũ ---
      form.addEventListener("submit", async e => {
        e.preventDefault();
        submitBtn.disabled = true;
        resultBox.textContent = "Đang xử lý...";
    
        const fd = new FormData(e.target);
        if (convertedImageFile) {
          fd.set("file", convertedImageFile);
        }
    
        try {
          const res = await fetch("{{ api_host }}/vision-qa", { method: "POST", body: fd, credentials: "include" });
          const text = await res.text();
          let data; try { data = JSON.parse(text); } catch { data = { error: text }; }
          if (!res.ok) {
            if (res.status === 429 || text.includes("Too many requests")) {
              throw new Error("Too many requests"); 
            }
            throw new Error(data.error || ("HTTP error " + res.status));
          }
    
          const loadingModal = new bootstrap.Modal(document.getElementById("loadingModal"));
          loadingModal.show();

          // Lấy danh sách task hiện tại
          let taskList = JSON.parse(localStorage.getItem('taskList')) || [];

          const isDoctor = {{ 'true' if isDoctor else 'false' }};

          const patientInput = document.querySelector('input[name="patient_id"]'); // hidden input

          let patientId, diseaseText, modelText;

          if (isDoctor) {
            const idOption = idSelect.options[idSelect.selectedIndex];
            const diseaseOption = diseaseSelect.options[diseaseSelect.selectedIndex];
            const modelOption = modelSelect.options[modelSelect.selectedIndex];

            patientId = idOption ? idOption.text : '';
            diseaseText = diseaseOption ? diseaseOption.text : '';
            modelText = modelOption ? modelOption.text : '';
          } else {
            patientId = patientInput ? patientInput.value : '';
            diseaseText = diseaseSelect.options[diseaseSelect.selectedIndex]?.text || '';
            modelText = modelSelect.options[modelSelect.selectedIndex]?.text || '';
          }

          // Tạo object lưu task info
          const taskInfo = {
            task_type: "Vision Q&A",
            task_id: data.task_id,
            patient_id: patientId,
            disease: diseaseText,
            model: modelText,
            uploaded_at: new Date().toLocaleString()
          };

          // Thêm vào list nếu chưa có
          taskList.push(taskInfo);

          // Lưu lại vào localStorage
          localStorage.setItem('taskList', JSON.stringify(taskList));
    
          let result = null;
          while (true) {
            await new Promise(r => setTimeout(r, 5000));
            const statusResp = await fetch(`{{ api_host }}/vqaStatus/${data.task_id}`, { credentials: 'include' });
            const statusData = await statusResp.json();
            if (statusData.status === "finished") { result = statusData.result; break; }
            if (statusData.status === "failed") throw new Error(statusData.error || "Task failed");
          }
    
          loadingModal.hide();
          resultBox.style.color = 'green';
          resultBox.textContent = result.answer;
          hljs.highlightElement(resultBox);
        } catch (err) {
          resultBox.textContent = "Lỗi: " + err.message;
          alert("Fetch error: " + err.message);
        } finally {
          submitBtn.disabled = false;
        }
      });
    });
    </script>
    
</body>
</html>
